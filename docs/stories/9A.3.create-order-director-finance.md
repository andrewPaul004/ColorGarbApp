# Story 9A.3: Create New Order - Director & Finance Users

**Status:** Ready for Development  
**Priority:** Critical  
**Sprint:** Sprint 2 (Immediate)  
**Story Type:** Core Business Feature  
**Related Epic:** Epic 9A - Critical Business Features

## Story

As a **band director or finance user**,  
I want **to create new orders directly in the portal using a streamlined form**,  
so that **I can initiate orders efficiently without external processes or manual intervention**.

## Business Context

**Problem:** Currently there is no way to create new orders in the system, blocking the primary business workflow. All order creation must happen outside the system, creating operational inefficiencies and manual data entry overhead.

**Impact:**
- Directors and Finance users cannot initiate orders through the portal
- Business operations require external workarounds and manual processes  
- Order data must be manually entered by ColorGarb staff after external communication
- Poor user experience forces users to use multiple systems/processes

**Business Value:**
- Enables core business workflow (order creation) for primary user roles
- Eliminates manual data entry overhead for ColorGarb staff
- Improves user experience by consolidating order management in single portal
- Provides immediate order confirmation and tracking from creation

## Acceptance Criteria

### Functional Requirements

1. **Access Control**
   - Order creation form accessible from main dashboard for Director/Finance roles only
   - ColorGarb staff and other roles cannot access this Director/Finance creation form
   - Clear navigation path from dashboard to order creation

2. **Form Fields and Validation**
   - Required field: "Order Description" (max 500 characters)
   - Required field: "When will you provide measurements?" with date picker validation (must be future date)
   - Required field: "When do you need these by?" with date picker validation (must be after measurement date)
   - Optional field: "Do you need a sample prior to production?" (yes/no selection)
   - Optional field: "Additional Notes" (max 2000 characters)
   - All required fields must be completed before form submission
   - Date validation ensures logical order: measurement date < delivery date

3. **Order Creation Logic**
   - Order automatically associated with authenticated user's organization (no selection needed)
   - Order number automatically generated following existing pattern (CG-YYYY-XXX)
   - Default order stage set to "Design Proposal" (first stage in manufacturing process)
   - Total amount defaults to $0.00 with "Pending Design Approval" status
   - Payment status defaults to "Pending"
   - Order marked as Active by default

4. **Email Notifications**
   - Order creation triggers immediate email notification to ColorGarb staff with order details
   - Email includes: Organization name, Order number, Description, Key dates, User contact info
   - Confirmation email sent to user with order details and next steps

5. **Success Flow**
   - Confirmation screen displays order details, assigned order number, and clear next steps
   - User redirected to new order's detail page after confirmation
   - New order appears immediately in user's order list

### Technical Requirements

6. **API Design**
   - New endpoint: `POST /api/orders` for Director/Finance order creation
   - Request validation following existing API patterns
   - Error handling with specific validation messages
   - Response includes complete order object with generated fields

7. **Frontend Implementation**  
   - Mobile-responsive form layout following existing Material-UI design patterns
   - Form validation with real-time feedback
   - Loading states during submission
   - Error handling with user-friendly messages
   - Success confirmation dialog

8. **Data Integrity**
   - Order creation includes audit trail entry
   - Database transaction ensures all related records created atomically
   - Created order follows all existing data model constraints

### User Experience Requirements

9. **Form Usability**
   - Intuitive form layout with clear field labels and help text
   - Date pickers with proper mobile support
   - Form auto-saves draft to prevent data loss (optional enhancement)
   - Clear indication of required vs optional fields

10. **Error Handling**
    - Network errors handled gracefully with retry options
    - Validation errors displayed inline with specific guidance
    - Server errors displayed with user-friendly messages
    - Form remains populated after non-critical errors

## Technical Investigation Required

### Backend Development
- [ ] Design CreateOrderRequest DTO following existing patterns
- [ ] Implement POST /api/orders endpoint with proper validation
- [ ] Add order creation to existing OrdersController
- [ ] Implement email notification service integration
- [ ] Add audit logging for order creation events

### Frontend Development
- [ ] Create CreateOrderDialog component following OrderStatusUpdate pattern
- [ ] Add Create Order button to main dashboard (role-based visibility)
- [ ] Implement form validation using existing validation patterns
- [ ] Add success/error handling following existing error patterns
- [ ] Integrate with existing routing and state management

### Integration Points
- [ ] Email service integration for staff notifications
- [ ] Audit service integration for creation logging
- [ ] Organization association logic
- [ ] Order number generation service

## Definition of Done

- [ ] Order creation form accessible to Director/Finance users from dashboard
- [ ] All form fields validate correctly with appropriate error messages
- [ ] Order creation succeeds and generates proper order number
- [ ] Email notifications sent to ColorGarb staff and user
- [ ] New order appears in user's order list immediately
- [ ] Confirmation screen displays with order details and next steps
- [ ] Mobile-responsive design works across target devices
- [ ] Unit and integration tests cover order creation flow
- [ ] Manual testing completed on multiple browsers and devices
- [ ] Code review completed and approved

## Testing Strategy

### Unit Tests
- [ ] Order creation API endpoint validation
- [ ] Form validation logic
- [ ] Error handling scenarios
- [ ] Email notification triggering

### Integration Tests
- [ ] End-to-end order creation flow
- [ ] Database transaction integrity
- [ ] Email service integration
- [ ] Role-based access control

### Manual Testing Scenarios
1. **Happy Path**
   - [ ] Director user creates order with all required fields
   - [ ] Finance user creates order with minimal required data
   - [ ] Order appears in list and detail page loads correctly
   - [ ] Email notifications received by staff and user

2. **Validation Testing**
   - [ ] Form prevents submission with missing required fields
   - [ ] Date validation prevents invalid date selections
   - [ ] Character limits enforced on text fields
   - [ ] Network error handling during submission

3. **Role-Based Testing**
   - [ ] Director role can access create order form
   - [ ] Finance role can access create order form
   - [ ] Other roles cannot access create order form
   - [ ] ColorGarb staff sees different admin creation flow (Story 9A.4)

## Success Metrics

- Order creation completion rate >95%
- Form submission success rate >98%
- Email notification delivery rate >99%
- User satisfaction with order creation flow >90%
- Average time to create order <3 minutes
- Zero critical bugs in order creation process

## Risk Mitigation

**Risk:** Order creation fails partway through process leaving incomplete data
**Mitigation:** Database transactions ensure atomicity, rollback on failure

**Risk:** Email notifications fail to send
**Mitigation:** Log failures, implement retry logic, provide admin interface to resend

**Risk:** Form validation allows invalid data
**Mitigation:** Server-side validation mirrors client-side validation, comprehensive test coverage

## Dependencies

- Existing Order model and database schema (no changes required)
- Email service infrastructure (existing)
- User authentication and role management (existing)
- Organization association logic (existing)

## Follow-up Stories

- Story 9A.4: Create New Order - ColorGarb Admin (enhanced admin creation)
- Future: Order template functionality for repeat orders
- Future: Bulk order creation for multiple similar orders
- Future: Integration with external design approval workflows